<div class="header-container container">
    <!-- Top Header: Mobile = Menu | Logo | Icons  /  Desktop = Logo + Search + Nav -->
    <div class="header-top-bar">

        <!-- Mobile Menu Toggle (LEFT on mobile, hidden on desktop) -->
        <button id="mobile-menu-trigger" class="mobile-menu-toggle" aria-label="Toggle Menu"
            onclick="toggleMobileMenu()">
            <svg viewBox="0 0 24 24" width="26" height="26" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <!-- Logo (CENTER on mobile, LEFT on desktop) -->
        <div class="header-logo-wrapper">
            <a href="{{ site.Home.Permalink }}" class="logo-link">
                <div class="logo-text">
                    <span class="logo-primary">Banana</span><span class="logo-secondary">BREAD</span>
                    <span class="logo-tagline">RECIPES COLLECTION</span>
                </div>
            </a>
        </div>

        <!-- Mobile Icons (RIGHT on mobile) -->
        <div class="mobile-header-icons">
            <button class="mobile-search-toggle" aria-label="Search" onclick="openSearch(event)">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </div>

        <!-- Main Navigation Integrated -->
        <nav class="main-nav">
            <!-- Close button for mobile -->
            <button class="mobile-nav-close" aria-label="Close Menu">
                &times;
            </button>
            <ul>
                {{ $page := . }}
                {{ range site.Menus.main }}
                <li class="{{ if or ($page.IsMenuCurrent " main" .) ($page.HasMenuCurrent "main" .) }}active{{ end }}">
                    <a href="{{ .URL }}">{{ .Name }}</a>
                </li>
                {{ end }}
            </ul>
        </nav>

        <!-- Inline Search Bar -->
        <div class="header-search-inline">
            <form class="search-form-inline" onsubmit="openSearch(event); return false;">
                <div class="search-input-container">
                    <svg class="search-icon-inline" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" placeholder="ingredient, recette, mot-clÃ©..." class="search-input-inline"
                        onclick="openSearch(event)" readonly>
                    <button type="submit" class="search-btn-inline">Search</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Failsafe direct toggle function
        function toggleMobileMenu() {
            const nav = document.querySelector('.main-nav');
            const trigger = document.getElementById('mobile-menu-trigger');
            if (!nav) return;
            const isActive = nav.classList.toggle('active');
            if (trigger) trigger.classList.toggle('is-active');
            document.body.style.overflow = isActive ? 'hidden' : '';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const nav = document.querySelector('.main-nav');
            const closeBtn = document.querySelector('.mobile-nav-close');

            if (closeBtn) closeBtn.addEventListener('click', toggleMobileMenu);

            const navLinks = nav.querySelectorAll('a');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (nav.classList.contains('active')) toggleMobileMenu();
                });
            });

            // Sticky header scroll effect
            const header = document.querySelector('.header-top-bar');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 30) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
        });
    </script>
</div>

<!-- Professional Search Modal -->
<div id="search-modal" class="search-modal">
    <div class="search-modal-content">
        <button class="close-search" onclick="closeSearch()">&times;</button>
        <div class="search-input-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="modal-search-input" placeholder="Type to search recipes..." autocomplete="off">
        </div>
        <div id="modal-search-results" class="modal-search-results"></div>
    </div>
</div>

<style>
    /* Search Modal Styles */
    .search-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 10vh;
    }

    .search-modal.active {
        opacity: 1;
        visibility: visible;
    }

    .search-modal-content {
        width: 100%;
        max-width: 700px;
        padding: 20px;
        position: relative;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }

    .search-modal.active .search-modal-content {
        transform: translateY(0);
    }

    .close-search {
        position: absolute;
        top: -40px;
        right: 0;
        background: none;
        border: none;
        font-size: 2.5rem;
        cursor: pointer;
        color: #333;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .close-search:hover {
        opacity: 1;
    }

    .search-input-wrapper {
        position: relative;
        border-bottom: 2px solid #eee;
        margin-bottom: 2rem;
    }

    .search-input-wrapper .search-icon {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        width: 30px;
        height: 30px;
    }

    #modal-search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        font-size: 2rem;
        border: none;
        background: transparent;
        color: #333;
        font-family: inherit;
        font-weight: 500;
    }

    #modal-search-input:focus {
        outline: none;
    }

    #modal-search-input::placeholder {
        color: #ccc;
    }

    .modal-search-results {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
    }

    /* Scrollbar for results */
    .modal-search-results::-webkit-scrollbar {
        width: 6px;
    }

    .modal-search-results::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .modal-search-results::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 3px;
    }

    .search-result-row {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        border-radius: 12px;
        transition: background 0.2s;
        text-decoration: none;
        color: inherit;
        border-bottom: 1px solid #f9f9f9;
    }

    .search-result-row:hover {
        background: #f8f8f8;
    }

    .search-result-row img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
    }

    .search-result-info h4 {
        margin: 0 0 5px 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .search-result-info p {
        margin: 0;
        font-size: 0.9rem;
        color: #777;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 400px;
    }

    body.search-open {
        overflow: hidden;
        /* Prevent scrolling main page */
    }
</style>

<script>
    let searchIndex = [];
    let isIndexLoaded = false;

    function loadSearchIndex() {
        if (isIndexLoaded) return;
        fetch('/index.json')
            .then(res => res.json())
            .then(data => {
                searchIndex = data;
                isIndexLoaded = true;
            })
            .catch(console.error);
    }

    function openSearch(e) {
        e.preventDefault();
        document.getElementById('search-modal').classList.add('active');
        document.body.classList.add('search-open');
        const input = document.getElementById('modal-search-input');
        input.value = '';
        input.focus();
        loadSearchIndex(); // Load data when opened
    }

    function closeSearch() {
        document.getElementById('search-modal').classList.remove('active');
        document.body.classList.remove('search-open');
    }

    // Close on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeSearch();
    });

    // Close on click outside (optional if covering screen)
    document.getElementById('search-modal').addEventListener('click', (e) => {
        if (e.target.id === 'search-modal') closeSearch();
    });

    // Search Logic
    document.getElementById('modal-search-input').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const resultsDiv = document.getElementById('modal-search-results');
        resultsDiv.innerHTML = '';

        if (query.length < 2) return;

        const results = searchIndex.filter(item => {
            return item.title.toLowerCase().includes(query) ||
                (item.summary && item.summary.toLowerCase().includes(query));
        }).slice(0, 5); // Limit to top 5

        if (results.length === 0) {
            resultsDiv.innerHTML = '<div style="text-align:center; padding: 20px; color: #999">No recipes found.</div>';
            return;
        }

        results.forEach(item => {
            const a = document.createElement('a');
            a.className = 'search-result-row';
            a.href = item.permalink;
            a.innerHTML = `
                <img src="${item.image}" alt="">
                <div class="search-result-info">
                    <h4>${item.title}</h4>
                    <p>${item.summary || ''}</p>
                </div>
            `;
            resultsDiv.appendChild(a);
        });
    });
</script>