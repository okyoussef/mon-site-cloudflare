{{- if eq .Kind "page" -}}
{{- if eq .Type "recette" -}}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Recipe",
  "name": "{{ .Title }}",
  "description": "{{ .Description }}",
  "image": [
    {{ with .Params.image }}
    "{{ . | absURL }}"
    {{ else }}
    "{{ .Site.BaseURL }}images/{{ .File.TranslationBaseName }}.jpg"
    {{ end }}
  ],
  "author": {
    "@type": "Person",
    "name": "{{ .Site.Params.author | default "Chef Cuisine" }}"
  },
  "datePublished": "{{ .Date.Format "2006-01-02" }}",
  "prepTime": "PT{{ .Params.preparation_time | replaceRE `[^0-9]` "" | default "15" }}M",
  {{/* CORRECTION DU FORMAT cookTime */}}
  "cookTime": "{{ with .Params.cooking_time }}{{ if findRE `h` . }}{{ $parts := split . "h" }}{{ $hours := index $parts 0 | replaceRE `[^0-9]` "" }}{{ $minutes := index $parts 1 | replaceRE `[^0-9]` "" | default "0" }}PT{{ $hours }}H{{ if ne $minutes "0" }}{{ $minutes }}M{{ end }}{{ else }}PT{{ replaceRE `[^0-9]` "" . }}M{{ end }}{{ else }}PT30M{{ end }}",
  {{/* CALCUL CORRECT DU totalTime */}}
  {{ $prepMinutes := .Params.preparation_time | replaceRE `[^0-9]` "" | default "15" | int }}
  {{ $cookTime := .Params.cooking_time | default "30 min" }}
  {{ $cookMinutes := 0 }}
  {{ if findRE `h` $cookTime }}
    {{ $parts := split $cookTime "h" }}
    {{ $hours := index $parts 0 | replaceRE `[^0-9]` "" | int }}
    {{ $mins := index $parts 1 | replaceRE `[^0-9]` "" | default "0" | int }}
    {{ $cookMinutes = add (mul $hours 60) $mins }}
  {{ else }}
    {{ $cookMinutes = $cookTime | replaceRE `[^0-9]` "" | int }}
  {{ end }}
  {{ $totalMinutes := add $prepMinutes $cookMinutes }}
  {{ $totalHours := div $totalMinutes 60 }}
  {{ $remainingMinutes := mod $totalMinutes 60 }}
  "totalTime": "PT{{ if gt $totalHours 0 }}{{ $totalHours }}H{{ end }}{{ if gt $remainingMinutes 0 }}{{ $remainingMinutes }}M{{ end }}",
  "recipeYield": "{{ .Params.servings }}",
  "recipeCategory": "{{ with .Params.categories }}{{ index . 0 }}{{ else }}Recette{{ end }}",
  "recipeCuisine": "{{ if in .Params.categories "Marocain" }}Moroccan{{ else if in .Params.categories "Italien" }}Italian{{ else if in .Params.categories "Français" }}French{{ else if in .Params.categories "Méditerranéen" }}Mediterranean{{ else }}International{{ end }}",
  "keywords": "{{ with .Params.tags }}{{ delimit . ", " }}{{ else }}{{ delimit .Params.categories ", " }}{{ end }}",
  "recipeIngredient": [
    {{ range $i, $e := .Params.ingredients }}
    "{{ . }}"{{ if ne (len $.Params.ingredients) (add $i 1) }},{{ end }}
    {{ end }}
  ],
  {{/* AMÉLIORATION DES INSTRUCTIONS AVEC name POUR CHAQUE ÉTAPE */}}
  "recipeInstructions": [
    {{ $content := .Content | plainify }}
    {{/* Extraction des étapes avec "Étape X :" */}}
    {{ $steps := findRE `Étape \d+ : [^:]+` $content }}
    {{ if $steps }}
      {{ range $index, $step := $steps }}
      {
        "@type": "HowToStep",
        "name": "{{ $step }}",
        "text": "{{ $step }}"
      }{{ if not (eq $index (sub (len $steps) 1)) }},{{ end }}
      {{ end }}
    {{ else }}
      {{/* Fallback : extraction des phrases numérotées */}}
      {{ $fallbackSteps := findRE `\d+\.\s+[^\.]+\.` $content }}
      {{ if $fallbackSteps }}
        {{ range $index, $step := first 6 $fallbackSteps }}
        {
          "@type": "HowToStep",
          "name": "Étape {{ add $index 1 }}",
          "text": "{{ replace $step "\"" "'" }}"
        }{{ if not (eq $index (sub (len (first 6 $fallbackSteps)) 1)) }},{{ end }}
        {{ end }}
      {{ else }}
        {{/* Dernier recours : premières phrases */}}
        {{ $paragraphs := split (.Content | plainify) ". " }}
        {{ range $index, $para := first 3 $paragraphs }}
        {
          "@type": "HowToStep",
          "name": "Étape {{ add $index 1 }}",
          "text": "{{ replace $para "\"" "'" }}."
        }{{ if not (eq $index (sub (len (first 3 $paragraphs)) 1)) }},{{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  ],
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ .Params.rating }}",
    "ratingCount": "{{ .Params.vote_count }}",
    "bestRating": "5",
    "worstRating": "1"
  },
  "nutrition": {
    "@type": "NutritionInformation"
    {{ with .Params.calories }}
    ,"calories": "{{ . }}"
    {{ end }}
    {{ with .Params.carbs }}
    ,"carbohydrateContent": "{{ . }}"
    {{ end }}
    {{ with .Params.protein }}
    ,"proteinContent": "{{ . }}"
    {{ end }}
    {{ with .Params.fat }}
    ,"fatContent": "{{ . }}"
    {{ end }}
  }
  {{ with .Params.video }}
  ,"video": {
    "@type": "VideoObject",
    "name": "{{ $.Title }}",
    "description": "{{ $.Description }}",
    "contentUrl": "{{ . }}",
    "thumbnailUrl": "{{ $.Params.video_thumbnail | default $.Params.image | absURL }}",
    "uploadDate": "{{ $.Date.Format "2006-01-02" }}"
  }
  {{ end }}
}
</script>
{{- end -}}
{{- end -}}